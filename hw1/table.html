<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">

<head>
    <meta charset="utf-8">
    <title>CS171-HW1: Table</title>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
    <style type="text/css">

        table {
            border-collapse: collapse;
            border-spacing: 1px;
        }

        caption,td,th,tr {
            border: 1px solid darkgrey;
            padding-left:7px;
            padding-right:7px;
            padding-top:4px;
            padding-bottom:4px;
        }

        th {
            padding-left:24px;
            padding-right:24px;

            background-image: url(img/bg.gif);
            background-repeat: no-repeat;
            background-position: center right;

            cursor: pointer;
        }

        th[chosen = true] {
            background-color: cornflowerblue;
        }

        th.headerSortUp {
            background-image: url(img/asc.gif);
        }

        th.headerSortDown {
            background-image: url(img/desc.gif);
        }

        tr.row[chosen = true] {
            background-color: yellow;
        }

        tr.odd {
            background-color: lightgray;
        }

        tr.even {
            background-color: ghostwhite;
        }



    </style>
</head>

<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>
    // Specific cols we want in table, along with index mapping
    var dataMapping = { "name":0, "continent":1, "gdp":2, "life_expectancy":3, "population":4, "year":5 };
    var SelectedCols = Object.keys(dataMapping);
    var CenteredCols = 2;

    d3.json("data/countries_2012.json", function(error, data){

        var columns = SelectedCols;
        var sortDown = false;

        var table = d3.select("body").append("table"),
                thead = table.append("thead")
                        .attr("class", "thead");
        tbody = table.append("tbody");

        table.append("caption")
                .html("World Countries Ranking");

        thead.append("tr").selectAll("th")
                .data(columns)
                .enter()
                .append("th")
                .text(function(d) { return d; })
                .on("click", function(header, i) {

                    sortDown = !sortDown;                   //Toggle Sort Order

                    tbody.selectAll("tr").sort(function (a, b) {
                        if (sortDown)   return d3.ascending(a[header], b[header]);
                        else            return d3.descending(a[header], b[header]);
                    });

                    UpdateTable();                          //Reset/Update Table Accordingly

                    //Highlight Header On Selection
                    var elt = d3.select(this);
                    elt.attr( "chosen", true);
                    elt.classed( sortDown    ? "headerSortDown" : "headerSortUp", true);
                    elt.classed( !(sortDown) ? "headerSortDown" : "headerSortUp", false);

                });

        var rows = tbody.selectAll("tr.row")
                .data(data)
                .enter()
                .append("tr").attr("class", "row")
                .on( "mouseover", function() {                      //Hover ON
                    d3.select(this).attr("chosen", true);
                })
                .on( "mouseout", function(d,i) {
                    d3.select(this).attr("chosen", false);          //Hover OFF
                })
                .style( "background-color", function(d,i){          //Initialize Zebra Pattern
                    var elt = d3.select(this);
                    elt.classed( (i%2)==0 ? "odd" : "even", true);
                    elt.classed( (i%2)==1 ? "odd" : "even", false);
                });

        var cells = rows.selectAll("td")
                .data(function(row) {
                    return SelectedCols.map(function(column) {
                        return row[column];
                    });
                })
                .enter()
                .append("td")
                .text(function(d, i) {

                //Format columns based on header
                    if( i === dataMapping.gdp)              d = d3.round(d/1e9, 1) + "G";
                    if( i === dataMapping.life_expectancy)  d = d3.format(".1f")(d);
                    if( i === dataMapping.population)       d = d3.format(",")(d);
                    return d;
                })

                .style("text-align", function(d,i){

                //Format alignment based on left-most cols
                    if( i < CenteredCols )  return "center";
                    else                    return "right";
                });

        var UpdateTable = function(){
            thead.selectAll("th")                                       //Reset Header Labels
                    .attr("chosen", false)
                    .classed( "headerSortUp", false)
                    .classed( "headerSortDown", false);

            tbody.selectAll("tr.row")
                    .each( function(d,i){                               //Update Zebra Pattern
                        var elt = d3.select(this);
                        elt.classed( (i%2)==0 ? "odd" : "even", true);
                        elt.classed( (i%2)==1 ? "odd" : "even", false);
                    }
            );
        };

    });





</script>
</body>
</html>